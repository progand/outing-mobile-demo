"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var core_1 = require("@angular/core");
var http_1 = require("@angular/http");
var Rx_1 = require("rxjs/Rx");
require("rxjs/add/operator/map");
var config_1 = require("../config");
var trip_1 = require("./trip");
var TripListService = (function () {
    function TripListService(http) {
        this.http = http;
    }
    TripListService.prototype.load = function () {
        var _this = this;
        return this.http.get(config_1.Config.apiUrl + "/models/trips?action=includeRelationships")
            .map(function (res) { return res.json(); })
            .map(function (data) {
            var list = [];
            var trips = _this.deserialize(data);
            trips.forEach(function (trip) {
                list.push(new trip_1.Trip(trip.id, trip.name, trip.destination, null, null, null, trip.budgetFrom, trip.budgetTo, trip.approvedTravellersCount, trip.partnersReqd, trip.coverPhoto, trip.organiser, new Date(trip.dateStart), new Date(trip.dateEnd), null, null, null));
            });
            return list;
        })
            .catch(this.handleErrors);
    };
    TripListService.prototype.loadOne = function (id) {
        var _this = this;
        var promise = this.http.get(config_1.Config.apiUrl + "/models/trips/" + id)
            .toPromise()
            .then(function (res) { return res.json(); })
            .then(function (data) { return data.trip; })
            .then(function (trip) { return Promise.all([
            trip,
            _this.http.get(config_1.Config.apiUrl + "/models/travellers/?ids[]=" + trip.travellers.join("&ids[]="))
                .toPromise()
                .then(function (res) { return res.json(); })
                .then(function (data) { return data.travellers; })
        ]); })
            .then(function (_a) {
            var trip = _a[0], travellers = _a[1];
            return Promise.all([
                trip,
                travellers,
                _this.http.get(config_1.Config.apiUrl + "/models/users/?ids[]=" + travellers
                    .reduce(function (result, travellerData) { return result.concat([travellerData.user]); }, [])
                    .join("&ids[]="))
                    .toPromise()
                    .then(function (res) { return res.json(); })
                    .then(function (data) { return data.users; })
            ]);
        })
            .then(function (_a) {
            var trip = _a[0], travellers = _a[1], users = _a[2];
            return Promise.all([
                trip,
                travellers,
                users,
                _this.http.get(config_1.Config.apiUrl + "/models/photos/?ids[]=" + trip.photos
                    .concat(travellers.reduce(function (result, traveller) {
                    var user = _this.getByValue(users, traveller.user);
                    return result.concat([user.photo]);
                }, []))
                    .join("&ids[]="))
                    .toPromise()
                    .then(function (res) { return res.json(); })
                    .then(function (data) { return data.photos; })
            ]);
        })
            .then(function (_a) {
            var trip = _a[0], travellers = _a[1], users = _a[2], photos = _a[3];
            return Object.assign({}, trip, {
                coverPhoto: _this.getByValue(photos, trip.coverPhoto),
                photos: trip.photos.map(function (photoId) { return _this.getByValue(photos, photoId); }),
                travellers: trip.travellers
                    .map(function (travellerId) { return _this.getByValue(travellers, travellerId); })
                    .map(function (traveller) {
                    var user = _this.getByValue(users, traveller.user);
                    //console.dir(user);
                    //console.dir(photos)
                    return Object.assign({}, traveller, {
                        user: Object.assign({}, user, {
                            photo: _this.getByValue(photos, user.photo)
                        })
                    });
                })
            });
        });
        return Rx_1.Observable.fromPromise(promise);
    };
    TripListService.prototype.handleErrors = function (error) {
        console.log(JSON.stringify(error.json()));
        return Rx_1.Observable.throw(error);
    };
    TripListService.prototype.deserialize = function (data) {
        var _this = this;
        var trips = data.trips, photos = data.photos, users = data.users;
        var result = trips.map(function (item) {
            var organiserData = _this.getByValue(users, item.organiser);
            var organiser = Object.assign({}, organiserData, {
                photo: _this.getByValue(photos, organiserData.photo),
                photos: organiserData.photos.map(function (photoId) { return _this.getByValue(photos, photoId); })
            });
            var trip = Object.assign({}, item, {
                coverPhoto: _this.getByValue(photos, item.coverPhoto),
                photos: item.photos.map(function (photoId) { return _this.getByValue(photos, photoId); }),
                organiser: organiser
            });
            return trip;
        });
        return result;
    };
    TripListService.prototype.getByValue = function (collection, fieldValue, fieldName) {
        if (fieldName === void 0) { fieldName = 'id'; }
        return collection.find(function (item) { return item[fieldName] === fieldValue; });
    };
    TripListService = __decorate([
        core_1.Injectable(),
        __metadata("design:paramtypes", [http_1.Http])
    ], TripListService);
    return TripListService;
}());
exports.TripListService = TripListService;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidHJpcC1saXN0LnNlcnZpY2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJ0cmlwLWxpc3Quc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLHNDQUEyQztBQUMzQyxzQ0FBd0Q7QUFDeEQsOEJBQXFDO0FBQ3JDLGlDQUErQjtBQUUvQixvQ0FBbUM7QUFDbkMsK0JBQThCO0FBRzlCO0lBQ0kseUJBQW9CLElBQVU7UUFBVixTQUFJLEdBQUosSUFBSSxDQUFNO0lBQUksQ0FBQztJQUVuQyw4QkFBSSxHQUFKO1FBQUEsaUJBNkJDO1FBNUJHLE1BQU0sQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxlQUFNLENBQUMsTUFBTSxHQUFHLDJDQUEyQyxDQUFDO2FBQzVFLEdBQUcsQ0FBQyxVQUFBLEdBQUcsSUFBSSxPQUFBLEdBQUcsQ0FBQyxJQUFJLEVBQUUsRUFBVixDQUFVLENBQUM7YUFDdEIsR0FBRyxDQUFDLFVBQUEsSUFBSTtZQUNMLElBQUksSUFBSSxHQUFHLEVBQUUsQ0FBQztZQUNkLElBQU0sS0FBSyxHQUFHLEtBQUksQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLENBQUM7WUFDckMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxVQUFDLElBQUk7Z0JBQ2YsSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLFdBQUksQ0FBQyxJQUFJLENBQUMsRUFBRSxFQUN0QixJQUFJLENBQUMsSUFBSSxFQUNULElBQUksQ0FBQyxXQUFXLEVBQ2hCLElBQUksRUFDSixJQUFJLEVBQ0osSUFBSSxFQUNKLElBQUksQ0FBQyxVQUFVLEVBQ2YsSUFBSSxDQUFDLFFBQVEsRUFDYixJQUFJLENBQUMsdUJBQXVCLEVBQzVCLElBQUksQ0FBQyxZQUFZLEVBQ2pCLElBQUksQ0FBQyxVQUFVLEVBQ2YsSUFBSSxDQUFDLFNBQVMsRUFDZCxJQUFJLElBQUksQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLEVBQ3hCLElBQUksSUFBSSxDQUFDLElBQUksQ0FB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Q0FBQyxVQUFVLENBQUMsTUFBTSxFQUFFLElBQUksQ0FBQyxVQUFVLENBQUM7Z0JBQ3BELE1BQU0sRUFBRSxJQUFJLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxVQUFBLE9BQU8sSUFBSSxPQUFBLEtBQUksQ0FBQyxVQUFVLENBQUMsTUFBTSxFQUFFLE9BQU8sQ0FBQyxFQUFoQyxDQUFnQyxDQUFDO2dCQUNwRSxTQUFTLFdBQUE7YUFDWixDQUFDLENBQUM7WUFDSCxNQUFNLENBQUMsSUFBSSxDQUFDO1FBQ2hCLENBQUMsQ0FBQyxDQUFDO1FBRUgsTUFBTSxDQUFDLE1BQU0sQ0FBQztJQUNsQixDQUFDO0lBRUQsb0NBQVUsR0FBVixVQUFXLFVBQVUsRUFBRSxVQUFVLEVBQUUsU0FBZ0I7UUFBaEIsMEJBQUEsRUFBQSxnQkFBZ0I7UUFDL0MsTUFBTSxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsVUFBQSxJQUFJLElBQUksT0FBQSxJQUFJLENBQUMsU0FBUyxDQUFDLEtBQUssVUFBVSxFQUE5QixDQUE4QixDQUFDLENBQUM7SUFDbkUsQ0FBQztJQW5IUSxlQUFlO1FBRDNCLGlCQUFVLEVBQUU7eUNBRWlCLFdBQUk7T0FEckIsZUFBZSxDQW9IM0I7SUFBRCxzQkFBQztDQUFBLEFBcEhELElBb0hDO0FBcEhZLDBDQUFlIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSB9IGZyb20gXCJAYW5ndWxhci9jb3JlXCI7XG5pbXBvcnQgeyBIdHRwLCBIZWFkZXJzLCBSZXNwb25zZSB9IGZyb20gXCJAYW5ndWxhci9odHRwXCI7XG5pbXBvcnQgeyBPYnNlcnZhYmxlIH0gZnJvbSBcInJ4anMvUnhcIjtcbmltcG9ydCBcInJ4anMvYWRkL29wZXJhdG9yL21hcFwiO1xuXG5pbXBvcnQgeyBDb25maWcgfSBmcm9tIFwiLi4vY29uZmlnXCI7XG5pbXBvcnQgeyBUcmlwIH0gZnJvbSBcIi4vdHJpcFwiO1xuXG5ASW5qZWN0YWJsZSgpXG5leHBvcnQgY2xhc3MgVHJpcExpc3RTZXJ2aWNlIHtcbiAgICBjb25zdHJ1Y3Rvcihwcml2YXRlIGh0dHA6IEh0dHApIHsgfVxuXG4gICAgbG9hZCgpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuaHR0cC5nZXQoQ29uZmlnLmFwaVVybCArIFwiL21vZGVscy90cmlwcz9hY3Rpb249aW5jbHVkZVJlbGF0aW9uc2hpcHNcIilcbiAgICAgICAgICAgIC5tYXAocmVzID0+IHJlcy5qc29uKCkpXG4gICAgICAgICAgICAubWFwKGRhdGEgPT4ge1xuICAgICAgICAgICAgICAgIGxldCBsaXN0ID0gW107XG4gICAgICAgICAgICAgICAgY29uc3QgdHJpcHMgPSB0aGlzLmRlc2VyaWFsaXplKGRhdGEpO1xuICAgICAgICAgICAgICAgIHRyaXBzLmZvckVhY2goKHRyaXApID0+IHtcbiAgICAgICAgICAgICAgICAgICAgbGlzdC5wdXNoKG5ldyBUcmlwKHRyaXAuaWQsXG4gICAgICAgICAgICAgICAgICAgICAgICB0cmlwLm5hbWUsXG4gICAgICAgICAgICAgICAgICAgICAgICB0cmlwLmRlc3RpbmF0aW9uLFxuICAgICAgICAgICAgICAgICAgICAgICAgbnVsbCxcbiAgICAgICAgICAgICAgICAgICAgICAgIG51bGwsXG4gICAgICAgICAgICAgICAgICAgICAgICBudWxsLFxuICAgICAgICAgICAgICAgICAgICAgICAgdHJpcC5idWRnZXRGcm9tLFxuICAgICAgICAgICAgICAgICAgICAgICAgdHJpcC5idWRnZXRUbyxcbiAgICAgICAgICAgICAgICAgICAgICAgIHRyaXAuYXBwcm92ZWRUcmF2ZWxsZXJzQ291bnQsXG4gICAgICAgICAgICAgICAgICAgICAgICB0cmlwLnBhcnRuZXJzUmVxZCxcbiAgICAgICAgICAgICAgICAgICAgICAgIHRyaXAuY292ZXJQaG90byxcbiAgICAgICAgICAgICAgICAgICAgICAgIHRyaXAub3JnYW5pc2VyLFxuICAgICAgICAgICAgICAgICAgICAgICAgbmV3IERhdGUodHJpcC5kYXRlU3RhcnQpLFxuICAgICAgICAgICAgICAgICAgICAgICAgbmV3IERhdGUodHJpcC5kYXRlRW5kKSxcbiAgICAgICAgICAgICAgICAgICAgICAgIG51bGwsXG4gICAgICAgICAgICAgICAgICAgICAgICBudWxsLFxuICAgICAgICAgICAgICAgICAgICAgICAgbnVsbCxcbiAgICAgICAgICAgICAgICAgICAgKSk7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgcmV0dXJuIGxpc3Q7XG4gICAgICAgICAgICB9KVxuICAgICAgICAgICAgLmNhdGNoKHRoaXMuaGFuZGxlRXJyb3JzKTtcbiAgICB9XG5cbiAgICBsb2FkT25lKGlkOiBTdHJpbmcpIHtcbiAgICAgICAgY29uc3QgcHJvbWlzZSA9IHRoaXMuaHR0cC5nZXQoQ29uZmlnLmFwaVVybCArIFwiL21vZGVscy90cmlwcy9cIiArIGlkKVxuICAgICAgICAgICAgLnRvUHJvbWlzZSgpXG4gICAgICAgICAgICAudGhlbihyZXMgPT4gcmVzLmpzb24oKSlcbiAgICAgICAgICAgIC50aGVuKGRhdGEgPT4gZGF0YS50cmlwKVxuICAgICAgICAgICAgLnRoZW4odHJpcCA9PiBQcm9taXNlLmFsbChbXG4gICAgICAgICAgICAgICAgdHJpcCxcbiAgICAgICAgICAgICAgICB0aGlzLmh0dHAuZ2V0KENvbmZpZy5hcGlVcmwgKyBcIi9tb2RlbHMvdHJhdmVsbGVycy8/aWRzW109XCIgKyB0cmlwLnRyYXZlbGxlcnMuam9pbihcIiZpZHNbXT1cIikpXG4gICAgICAgICAgICAgICAgICAgIC50b1Byb21pc2UoKVxuICAgICAgICAgICAgICAgICAgICAudGhlbihyZXMgPT4gcmVzLmpzb24oKSlcbiAgICAgICAgICAgICAgICAgICAgLnRoZW4oZGF0YSA9PiBkYXRhLnRyYXZlbGxlcnMpXG4gICAgICAgICAgICBdKSlcbiAgICAgICAgICAgIC50aGVuKChbdHJpcCwgdHJhdmVsbGVyc10pID0+IFByb21pc2UuYWxsKFtcbiAgICAgICAgICAgICAgICB0cmlwLFxuICAgICAgICAgICAgICAgIHRyYXZlbGxlcnMsXG4gICAgICAgICAgICAgICAgdGhpcy5odHRwLmdldChDb25maWcuYXBpVXJsICsgXCIvbW9kZWxzL3VzZXJzLz9pZHNbXT1cIiArIHRyYXZlbGxlcnNcbiAgICAgICAgICAgICAgICAgICAgLnJlZHVjZSgocmVzdWx0LCB0cmF2ZWxsZXJEYXRhKSA9PiByZXN1bHQuY29uY2F0KFt0cmF2ZWxsZXJEYXRhLnVzZXJdKSwgW10pXG4gICAgICAgICAgICAgICAgICAgIC5qb2luKFwiJmlkc1tdPVwiKSlcbiAgICAgICAgICAgICAgICAgICAgLnRvUHJvbWlzZSgpXG4gICAgICAgICAgICAgICAgICAgIC50aGVuKHJlcyA9PiByZXMuanNvbigpKVxuICAgICAgICAgICAgICAgICAgICAudGhlbihkYXRhID0+IGRhdGEudXNlcnMpXG4gICAgICAgICAgICBdKSlcbiAgICAgICAgICAgIC50aGVuKChbdHJpcCwgdHJhdmVsbGVycywgdXNlcnNdKSA9PiBQcm9taXNlLmFsbChbXG4gICAgICAgICAgICAgICAgdHJpcCxcbiAgICAgICAgICAgICAgICB0cmF2ZWxsZXJzLFxuICAgICAgICAgICAgICAgIHVzZXJzLFxuICAgICAgICAgICAgICAgIHRoaXMuaHR0cC5nZXQoQ29uZmlnLmFwaVVybCArIFwiL21vZGVscy9waG90b3MvP2lkc1tdPVwiICsgdHJpcC5waG90b3NcbiAgICAgICAgICAgICAgICAgICAgLmNvbmNhdCh0cmF2ZWxsZXJzLnJlZHVjZSgocmVzdWx0LCB0cmF2ZWxsZXIpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHVzZXIgPSB0aGlzLmdldEJ5VmFsdWUodXNlcnMsIHRyYXZlbGxlci51c2VyKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiByZXN1bHQuY29uY2F0KFt1c2VyLnBob3RvXSk7XG4gICAgICAgICAgICAgICAgICAgIH0sIFtdKSlcbiAgICAgICAgICAgICAgICAgICAgLmpvaW4oXCImaWRzW109XCIpKVxuICAgICAgICAgICAgICAgICAgICAudG9Qcm9taXNlKClcbiAgICAgICAgICAgICAgICAgICAgLnRoZW4ocmVzID0+IHJlcy5qc29uKCkpXG4gICAgICAgICAgICAgICAgICAgIC50aGVuKGRhdGEgPT4gZGF0YS5waG90b3MpXG4gICAgICAgICAgICBdKSlcbiAgICAgICAgICAgIC50aGVuKChbdHJpcCwgdHJhdmVsbGVycywgdXNlcnMsIHBob3Rvc10pID0+IE9iamVjdC5hc3NpZ24oe30sIHRyaXAsIHtcbiAgICAgICAgICAgICAgICBjb3ZlclBob3RvOiB0aGlzLmdldEJ5VmFsdWUocGhvdG9zLCB0cmlwLmNvdmVyUGhvdG8pLFxuICAgICAgICAgICAgICAgIHBob3RvczogdHJpcC5waG90b3MubWFwKHBob3RvSWQgPT4gdGhpcy5nZXRCeVZhbHVlKHBob3RvcywgcGhvdG9JZCkpLFxuICAgICAgICAgICAgICAgIHRyYXZlbGxlcnM6IHRyaXAudHJhdmVsbGVyc1xuICAgICAgICAgICAgICAgICAgICAubWFwKHRyYXZlbGxlcklkID0+IHRoaXMuZ2V0QnlWYWx1ZSh0cmF2ZWxsZXJzLCB0cmF2ZWxsZXJJZCkpXG4gICAgICAgICAgICAgICAgICAgIC5tYXAodHJhdmVsbGVyID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHVzZXIgPSB0aGlzLmdldEJ5VmFsdWUodXNlcnMsIHRyYXZlbGxlci51c2VyKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vY29uc29sZS5kaXIodXNlcik7XG4gICAgICAgICAgICAgICAgICAgICAgICAvL2NvbnNvbGUuZGlyKHBob3RvcylcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBPYmplY3QuYXNzaWduKHt9LCB0cmF2ZWxsZXIsIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB1c2VyOiBPYmplY3QuYXNzaWduKHt9LCB1c2VyLCB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBob3RvOiB0aGlzLmdldEJ5VmFsdWUocGhvdG9zLCB1c2VyLnBob3RvKVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgfSkpO1xuICAgICAgICByZXR1cm4gT2JzZXJ2YWJsZS5mcm9tUHJvbWlzZShwcm9taXNlKTtcbiAgICB9XG5cbiAgICBoYW5kbGVFcnJvcnMoZXJyb3I6IFJlc3BvbnNlKSB7XG4gICAgICAgIGNvbnNvbGUubG9nKEpTT04uc3RyaW5naWZ5KGVycm9yLmpzb24oKSkpO1xuICAgICAgICByZXR1cm4gT2JzZXJ2YWJsZS50aHJvdyhlcnJvcik7XG4gICAgfVxuXG4gICAgZGVzZXJpYWxpemUoZGF0YTogYW55KSB7XG4gICAgICAgIGNvbnN0IHsgdHJpcHMsIHBob3RvcywgdXNlcnMgfSA9IGRhdGE7XG4gICAgICAgIGNvbnN0IHJlc3VsdCA9IHRyaXBzLm1hcChpdGVtID0+IHtcbiAgICAgICAgICAgIGNvbnN0IG9yZ2FuaXNlckRhdGEgPSB0aGlzLmdldEJ5VmFsdWUodXNlcnMsIGl0ZW0ub3JnYW5pc2VyKTtcbiAgICAgICAgICAgIGNvbnN0IG9yZ2FuaXNlciA9IE9iamVjdC5hc3NpZ24oe30sIG9yZ2FuaXNlckRhdGEsIHtcbiAgICAgICAgICAgICAgICBwaG90bzogdGhpcy5nZXRCeVZhbHVlKHBob3Rvcywgb3JnYW5pc2VyRGF0YS5waG90byksXG4gICAgICAgICAgICAgICAgcGhvdG9zOiBvcmdhbmlzZXJEYXRhLnBob3Rvcy5tYXAocGhvdG9JZCA9PiB0aGlzLmdldEJ5VmFsdWUocGhvdG9zLCBwaG90b0lkKSlcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgY29uc3QgdHJpcCA9IE9iamVjdC5hc3NpZ24oe30sIGl0ZW0sIHtcbiAgICAgICAgICAgICAgICBjb3ZlclBob3RvOiB0aGlzLmdldEJ5VmFsdWUocGhvdG9zLCBpdGVtLmNvdmVyUGhvdG8pLFxuICAgICAgICAgICAgICAgIHBob3RvczogaXRlbS5waG90b3MubWFwKHBob3RvSWQgPT4gdGhpcy5nZXRCeVZhbHVlKHBob3RvcywgcGhvdG9JZCkpLFxuICAgICAgICAgICAgICAgIG9yZ2FuaXNlclxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICByZXR1cm4gdHJpcDtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICB9XG5cbiAgICBnZXRCeVZhbHVlKGNvbGxlY3Rpb24sIGZpZWxkVmFsdWUsIGZpZWxkTmFtZSA9ICdpZCcpIHtcbiAgICAgICAgcmV0dXJuIGNvbGxlY3Rpb24uZmluZChpdGVtID0+IGl0ZW1bZmllbGROYW1lXSA9PT0gZmllbGRWYWx1ZSk7XG4gICAgfVxufSJdfQ==